<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stock Quant Dashboard</title>
    <style>
      :root {
        --bg: #f4f7f8;
        --surface: #ffffff;
        --ink: #1b2a32;
        --muted: #5b6a71;
        --accent: #0f7a6a;
        --danger: #b33939;
        --ok: #1f8a4d;
        --line: #d8e0e3;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "IBM Plex Sans", "Noto Sans TC", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 0% 0%, #d8efe9 0%, transparent 35%),
          radial-gradient(circle at 100% 0%, #dbe8ff 0%, transparent 30%),
          var(--bg);
      }
      .wrap { max-width: 1000px; margin: 0 auto; padding: 24px 16px 60px; }
      h1 { margin: 0 0 12px; font-size: 30px; }
      .meta { color: var(--muted); margin-bottom: 20px; }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
      }
      .card {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 14px;
      }
      .label { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
      .value { font-size: 20px; font-weight: 700; }
      table {
        width: 100%;
        border-collapse: collapse;
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 12px;
        overflow: hidden;
      }
      th, td {
        text-align: left;
        padding: 10px;
        border-bottom: 1px solid var(--line);
        font-size: 14px;
      }
      th { background: #eef3f5; }
      .buy { color: var(--ok); font-weight: 700; }
      .sell { color: var(--danger); font-weight: 700; }
      .section-title { margin: 20px 0 10px; font-size: 18px; }
      .error { color: var(--danger); font-weight: 600; }
      .ok { color: var(--ok); font-weight: 600; }
      .footer { margin-top: 20px; color: var(--muted); font-size: 13px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Stock Quant Dashboard</h1>
      <div class="meta" id="meta">讀取中...</div>

      <div class="grid" id="summary"></div>

      <div class="section-title">長期表（3-12 個月）</div>
      <table>
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Date</th>
            <th>Close</th>
            <th>Score</th>
            <th>Signal</th>
            <th>Source</th>
          </tr>
        </thead>
        <tbody id="long-body"></tbody>
      </table>

      <div class="section-title">中期表（1-8 週）</div>
      <table>
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Date</th>
            <th>Close</th>
            <th>Score</th>
            <th>Signal</th>
            <th>Source</th>
          </tr>
        </thead>
        <tbody id="mid-body"></tbody>
      </table>

      <div class="section-title">短期表（1-10 天）</div>
      <table>
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Date</th>
            <th>Close</th>
            <th>Score</th>
            <th>Signal</th>
            <th>Source</th>
          </tr>
        </thead>
        <tbody id="short-body"></tbody>
      </table>

      <div class="section-title">最近執行</div>
      <table>
        <thead>
          <tr>
            <th>Run ID</th>
            <th>Started</th>
            <th>Finished</th>
            <th>Status</th>
            <th>Rows</th>
          </tr>
        </thead>
        <tbody id="runs-body"></tbody>
      </table>

      <div class="footer">
        Data source: generated by Python pipeline and published via GitHub Actions.
      </div>
    </div>

    <script>
      const fmt = (v) => new Intl.NumberFormat("en-US", { maximumFractionDigits: 4 }).format(v);

      function renderHorizonRows(rows, bodyId) {
        const body = document.getElementById(bodyId);
        body.innerHTML = (rows || [])
          .map((r) => {
            const signalClass = String(r.signal).toLowerCase() === "buy" ? "buy" : "sell";
            return `<tr>
              <td>${r.symbol}</td>
              <td>${r.trade_date}</td>
              <td>${fmt(r.close)}</td>
              <td>${r.score}</td>
              <td class="${signalClass}">${r.signal}</td>
              <td>${r.source || "-"}</td>
            </tr>`;
          })
          .join("");
      }

      async function load() {
        try {
          const res = await fetch("./data/latest.json", { cache: "no-store" });
          if (!res.ok) throw new Error("latest.json not found");
          const data = await res.json();

          const run = data.recent_runs?.[0];
          const meta = document.getElementById("meta");
          meta.textContent = run
            ? `Last run: ${run.finished_at || run.started_at} (${data.timezone})`
            : "No runs yet";

          const summary = document.getElementById("summary");
          const cards = [
            { label: "Run ID", value: data.run_id || "-" },
            { label: "Symbols", value: (data.short_term || []).length },
            { label: "Rows Written", value: data.details?.price_rows + data.details?.metric_rows || 0 },
            { label: "Status", value: run?.status || "-" },
          ];
          summary.innerHTML = cards
            .map((c) => `<div class="card"><div class="label">${c.label}</div><div class="value">${c.value}</div></div>`)
            .join("");

          renderHorizonRows(data.long_term, "long-body");
          renderHorizonRows(data.mid_term, "mid-body");
          renderHorizonRows(data.short_term, "short-body");

          const runsBody = document.getElementById("runs-body");
          runsBody.innerHTML = (data.recent_runs || [])
            .map((r) => {
              const statusClass = r.status === "SUCCESS" ? "ok" : "error";
              return `<tr>
                <td>${r.run_id.slice(0, 10)}</td>
                <td>${r.started_at || "-"}</td>
                <td>${r.finished_at || "-"}</td>
                <td class="${statusClass}">${r.status}</td>
                <td>${r.rows_written ?? 0}</td>
              </tr>`;
            })
            .join("");
        } catch (err) {
          document.getElementById("meta").textContent = "資料尚未建立，請先跑一次 pipeline。";
          console.error(err);
        }
      }
      load();
    </script>
  </body>
</html>
