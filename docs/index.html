<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stock Quant Dashboard</title>
    <style>
      :root {
        --bg: #f4f7f8;
        --surface: #ffffff;
        --ink: #1b2a32;
        --muted: #5b6a71;
        --danger: #b33939;
        --ok: #1f8a4d;
        --line: #d8e0e3;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "IBM Plex Sans", "Noto Sans TC", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 0% 0%, #d8efe9 0%, transparent 35%),
          radial-gradient(circle at 100% 0%, #dbe8ff 0%, transparent 30%),
          var(--bg);
      }
      .wrap { max-width: 1400px; margin: 0 auto; padding: 24px 16px 60px; }
      h1 { margin: 0 0 10px; font-size: 30px; }
      h2 { margin: 24px 0 10px; font-size: 18px; }
      .meta { color: var(--muted); margin-bottom: 14px; }
      .toolbar {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
      }
      select {
        border: 1px solid var(--line);
        border-radius: 10px;
        background: var(--surface);
        padding: 8px 10px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
        margin-bottom: 14px;
      }
      .card {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 14px;
      }
      .label { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
      .value { font-size: 20px; font-weight: 700; }
      .table-wrap {
        overflow-x: auto;
        border: 1px solid var(--line);
        border-radius: 12px;
        background: var(--surface);
      }
      table { width: 100%; border-collapse: collapse; min-width: 1800px; }
      th, td {
        text-align: left;
        padding: 8px;
        border-bottom: 1px solid var(--line);
        font-size: 13px;
        white-space: nowrap;
      }
      th { background: #eef3f5; position: sticky; top: 0; z-index: 1; }
      .buy { color: var(--ok); font-weight: 700; }
      .sell { color: var(--danger); font-weight: 700; }
      .strategy {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 14px;
        line-height: 1.55;
      }
      .footer { margin-top: 18px; color: var(--muted); font-size: 13px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Stock Quant Dashboard</h1>
      <div class="meta" id="meta">讀取中...</div>

      <div class="grid" id="summary"></div>

      <h2>推薦組合（最多 10 檔，目標年化 10%）</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Symbol</th>
              <th>Sector</th>
              <th>Current</th>
              <th>Expected Annual</th>
              <th>Predicted Sell</th>
              <th>Stop Loss</th>
              <th>Take Profit</th>
              <th>Total Score</th>
            </tr>
          </thead>
          <tbody id="portfolio-body"></tbody>
        </table>
      </div>

      <h2>全部股票總表（短中長期指標）</h2>
      <div class="toolbar">
        <label for="sector-filter">感興趣產業：</label>
        <select id="sector-filter">
          <option value="ALL">全部</option>
        </select>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Symbol</th>
              <th>Sector</th>
              <th>Date</th>
              <th>Source</th>
              <th>Current</th>
              <th>Predicted Sell</th>
              <th>Stop Loss</th>
              <th>Take Profit</th>
              <th>Expected Annual</th>
              <th>Total Score</th>

              <th>Short Score</th>
              <th>Short Signal</th>
              <th>SMA5</th>
              <th>MOM1D</th>
              <th>MOM5D</th>
              <th>VOL10D</th>

              <th>Mid Score</th>
              <th>Mid Signal</th>
              <th>SMA20</th>
              <th>SMA60</th>
              <th>MOM20D</th>

              <th>Long Score</th>
              <th>Long Signal</th>
              <th>SMA200</th>
              <th>MOM60D</th>
              <th>Dist52W High</th>
            </tr>
          </thead>
          <tbody id="stock-body"></tbody>
        </table>
      </div>

      <h2>選股策略（短中長）</h2>
      <div class="strategy">
        <div><b>短期（1-10天）</b>：看動能與波動。重點欄位 `MOM1D`、`MOM5D`、`VOL10D`、`Short Score`。</div>
        <div><b>中期（1-8週）</b>：看趨勢延續。重點欄位 `SMA20` 相對 `SMA60`、`MOM20D`、`Mid Score`。</div>
        <div><b>長期（3-12月）</b>：看大趨勢與結構。重點欄位 `SMA200`、`MOM60D`、`Dist52W High`、`Long Score`。</div>
        <div><b>組合規則</b>：優先挑 `Long=BUY` + `Mid=BUY`，且 `Expected Annual` 高於目標（預設 10%），最多 10 檔。</div>
        <div><b>風險控管</b>：進場後依 `Stop Loss` / `Take Profit` 執行，避免單一部位過大。</div>
      </div>

      <h2>最近執行</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Run ID</th>
              <th>Started</th>
              <th>Finished</th>
              <th>Status</th>
              <th>Rows</th>
            </tr>
          </thead>
          <tbody id="runs-body"></tbody>
        </table>
      </div>

      <div class="footer">Data generated by Python pipeline and published via GitHub Actions.</div>
    </div>

    <script>
      const fmt = (v) => new Intl.NumberFormat("en-US", { maximumFractionDigits: 4 }).format(v ?? 0);
      const pct = (v) => `${new Intl.NumberFormat("en-US", { maximumFractionDigits: 2 }).format((v ?? 0) * 100)}%`;

      let state = { stockTable: [] };

      function signalClass(v) {
        return String(v || "").toLowerCase() === "buy" ? "buy" : "sell";
      }

      function renderPortfolio(rows) {
        const body = document.getElementById("portfolio-body");
        body.innerHTML = (rows || []).map((r) => `
          <tr>
            <td>${r.symbol}</td>
            <td>${r.sector}</td>
            <td>${fmt(r.current_price)}</td>
            <td>${pct(r.expected_annual_return)}</td>
            <td>${fmt(r.predicted_sell_price)}</td>
            <td>${fmt(r.stop_loss_price)}</td>
            <td>${fmt(r.take_profit_price)}</td>
            <td>${r.total_score}</td>
          </tr>
        `).join("");
      }

      function renderStockTable(rows) {
        const body = document.getElementById("stock-body");
        body.innerHTML = (rows || []).map((r) => `
          <tr>
            <td>${r.symbol}</td>
            <td>${r.sector}</td>
            <td>${r.trade_date}</td>
            <td>${r.source || "-"}</td>
            <td>${fmt(r.current_price)}</td>
            <td>${fmt(r.predicted_sell_price)}</td>
            <td>${fmt(r.stop_loss_price)}</td>
            <td>${fmt(r.take_profit_price)}</td>
            <td>${pct(r.expected_annual_return)}</td>
            <td>${r.total_score}</td>

            <td>${r.short_score}</td>
            <td class="${signalClass(r.short_signal)}">${r.short_signal}</td>
            <td>${fmt(r.sma_5)}</td>
            <td>${pct(r.mom_1d)}</td>
            <td>${pct(r.mom_5d)}</td>
            <td>${pct(r.vol_10d)}</td>

            <td>${r.mid_score}</td>
            <td class="${signalClass(r.mid_signal)}">${r.mid_signal}</td>
            <td>${fmt(r.sma_20)}</td>
            <td>${fmt(r.sma_60)}</td>
            <td>${pct(r.mom_20d)}</td>

            <td>${r.long_score}</td>
            <td class="${signalClass(r.long_signal)}">${r.long_signal}</td>
            <td>${fmt(r.sma_200)}</td>
            <td>${pct(r.mom_60d)}</td>
            <td>${pct(r.dist_52w_high)}</td>
          </tr>
        `).join("");
      }

      function applySectorFilter() {
        const filter = document.getElementById("sector-filter").value;
        const rows = filter === "ALL"
          ? state.stockTable
          : state.stockTable.filter((r) => (r.sector || "Unknown") === filter);
        renderStockTable(rows);
      }

      async function load() {
        try {
          const res = await fetch("./data/latest.json", { cache: "no-store" });
          if (!res.ok) throw new Error("latest.json not found");
          const data = await res.json();

          state.stockTable = data.stock_table || [];

          const run = data.recent_runs?.[0];
          const meta = document.getElementById("meta");
          const annualTarget = pct(data.target_annual_return || 0.10);
          meta.textContent = run
            ? `Last run: ${run.finished_at || run.started_at} (${data.timezone}) | Universe: ${data.details?.universe || "manual"} | Target annual: ${annualTarget}`
            : "No runs yet";

          const summary = document.getElementById("summary");
          const cards = [
            { label: "Run ID", value: data.run_id || "-" },
            { label: "Symbols", value: (data.stock_table || []).length },
            { label: "Rows Written", value: (data.details?.price_rows || 0) + (data.details?.metric_rows || 0) },
            { label: "Recommended", value: (data.recommended_portfolio || []).length },
          ];
          summary.innerHTML = cards.map((c) => `<div class="card"><div class="label">${c.label}</div><div class="value">${c.value}</div></div>`).join("");

          const filter = document.getElementById("sector-filter");
          filter.innerHTML = `<option value="ALL">全部</option>` +
            (data.sectors || []).map((s) => `<option value="${s}">${s}</option>`).join("");
          filter.addEventListener("change", applySectorFilter);

          renderPortfolio(data.recommended_portfolio || []);
          applySectorFilter();

          const runsBody = document.getElementById("runs-body");
          runsBody.innerHTML = (data.recent_runs || []).map((r) => {
            const cls = r.status === "SUCCESS" ? "buy" : "sell";
            return `
              <tr>
                <td>${r.run_id.slice(0, 10)}</td>
                <td>${r.started_at || "-"}</td>
                <td>${r.finished_at || "-"}</td>
                <td class="${cls}">${r.status}</td>
                <td>${r.rows_written ?? 0}</td>
              </tr>
            `;
          }).join("");
        } catch (err) {
          document.getElementById("meta").textContent = "資料尚未建立，請先跑一次 pipeline。";
          console.error(err);
        }
      }

      load();
    </script>
  </body>
</html>
